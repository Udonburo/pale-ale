name: Rust CI

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test:
    # Default-features only is the authoritative path for Rust CLI builds.
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Rust fmt
        run: cargo fmt --all -- --check

      - name: Rust clippy
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Rust test
        run: cargo test --workspace

  python-wheel-smoke:
    # Guard against Python packaging regressions (module init symbol/import issues).
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install wheel build tooling
        run: python -m pip install --upgrade pip build maturin

      - name: Build wheel
        run: python -m build

      - name: Install built wheel
        run: |
          WHEEL="$(ls dist/*.whl | head -n 1)"
          echo "wheel=$WHEEL"
          python -m pip install --force-reinstall --no-deps "$WHEEL"

      - name: Verify module import and symbols
        run: |
          python - <<'PY'
          import pale_ale_core
          required = {"spin3_distance", "spin3_struct", "spin3_components", "spin3_struct_distance"}
          got = {name for name in dir(pale_ale_core) if name.startswith("spin3_")}
          missing = sorted(required - got)
          print("core_path=", pale_ale_core.__file__)
          print("symbols=", sorted(got))
          if missing:
              raise SystemExit(f"missing symbols: {missing}")
          PY
